# Codex rules for parent-agent + sub-agents orchestration flow.
# Scope: triage, review-spec, implementation, review-pr.

# -----------------------------
# Read-only GitHub operations
# -----------------------------
prefix_rule(
    pattern = ["gh", "issue", "list"],
    decision = "allow",
    justification = "Needed by triage/review-spec/implementation/review-pr discovery",
)

prefix_rule(
    pattern = ["gh", "issue", "view"],
    decision = "allow",
    justification = "Needed to revalidate issue state before acting",
)

prefix_rule(
    pattern = ["gh", "pr", "list"],
    decision = "allow",
    justification = "Needed to find PR candidates",
)

prefix_rule(
    pattern = ["gh", "pr", "view"],
    decision = "allow",
    justification = "Needed for PR inspection and status checks",
)

prefix_rule(
    pattern = ["gh", "pr", "checks"],
    decision = "allow",
    justification = "Needed to wait for/check CI completion",
)

# -----------------------------
# Mutating GitHub operations
# -----------------------------
prefix_rule(
    pattern = ["gh", "issue", "edit"],
    decision = "allow",
    justification = "Needed for labels/lock transitions in state machine",
)

prefix_rule(
    pattern = ["gh", "issue", "comment"],
    decision = "allow",
    justification = "Needed for agent audit comments in issues",
)

prefix_rule(
    pattern = ["gh", "issue", "close"],
    decision = "allow",
    justification = "Needed when review-pr-agent merges and closes issue",
)

prefix_rule(
    pattern = ["gh", "pr", "comment"],
    decision = "allow",
    justification = "Needed for blocking findings and resolution notes",
)

prefix_rule(
    pattern = ["gh", "pr", "create"],
    decision = "allow",
    justification = "Needed by review-spec/implementation handoff",
)

prefix_rule(
    pattern = ["gh", "pr", "edit"],
    decision = "allow",
    justification = "Needed to update PR body and metadata",
)

prefix_rule(
    pattern = ["gh", "pr", "merge"],
    decision = "allow",
    justification = "Needed by review-pr-agent when decision is lgtm",
)

# -----------------------------
# Git operations used by agents
# -----------------------------
prefix_rule(
    pattern = ["git", "status"],
    decision = "allow",
    justification = "Needed for safe repo state checks",
)

prefix_rule(
    pattern = ["git", "diff"],
    decision = "allow",
    justification = "Needed for review and verification",
)

prefix_rule(
    pattern = ["git", "log"],
    decision = "allow",
    justification = "Needed for traceability checks",
)

prefix_rule(
    pattern = ["git", "fetch"],
    decision = "allow",
    justification = "Needed to sync branches before merge/push",
)

prefix_rule(
    pattern = ["git", "pull"],
    decision = "allow",
    justification = "Needed to sync local branch with remote",
)

prefix_rule(
    pattern = ["git", "checkout"],
    decision = "allow",
    justification = "Needed for branch/worktree context switching",
)

prefix_rule(
    pattern = ["git", "switch"],
    decision = "allow",
    justification = "Needed for branch/worktree context switching",
)

prefix_rule(
    pattern = ["git", "branch"],
    decision = "allow",
    justification = "Needed to create/list branches for issues",
)

prefix_rule(
    pattern = ["git", "worktree", "add"],
    decision = "allow",
    justification = "Needed for isolated per-issue execution",
)

prefix_rule(
    pattern = ["git", "worktree", "remove"],
    decision = "allow",
    justification = "Needed for mandatory cleanup after implementation",
)

prefix_rule(
    pattern = ["git", "add"],
    decision = "allow",
    justification = "Needed to stage implementation/spec changes",
)

prefix_rule(
    pattern = ["git", "commit"],
    decision = "allow",
    justification = "Needed to persist issue-level changes",
)

prefix_rule(
    pattern = ["git", "merge"],
    decision = "allow",
    justification = "Needed for controlled integration flow",
)

prefix_rule(
    pattern = ["git", "push"],
    decision = "allow",
    justification = "Needed to publish branches and updates",
)

# -----------------------------
# Project validation/tooling
# -----------------------------
prefix_rule(
    pattern = ["pnpm", "install"],
    decision = "allow",
    justification = "Needed to prepare dependencies in worktrees",
)

prefix_rule(
    pattern = ["pnpm", "run", "lint"],
    decision = "allow",
    justification = "Needed in validation workflow",
)

prefix_rule(
    pattern = ["pnpm", "run", "test:unit"],
    decision = "allow",
    justification = "Needed in validation workflow",
)

prefix_rule(
    pattern = ["pnpm", "run", "test:coverage"],
    decision = "allow",
    justification = "Needed in validation workflow",
)

prefix_rule(
    pattern = ["pnpm", "run", "validate"],
    decision = "allow",
    justification = "Primary project validation gate",
)

# -----------------------------
# Explicitly forbidden actions
# -----------------------------
prefix_rule(
    pattern = ["git", "reset", "--hard"],
    decision = "forbidden",
    justification = "Destructive history rewrite is prohibited",
)

prefix_rule(
    pattern = ["git", "clean", "-fd"],
    decision = "forbidden",
    justification = "Destructive workspace cleanup is prohibited",
)

prefix_rule(
    pattern = ["git", "clean", "-fdx"],
    decision = "forbidden",
    justification = "Destructive workspace cleanup is prohibited",
)

prefix_rule(
    pattern = ["git", "push", "--force"],
    decision = "forbidden",
    justification = "Force push is prohibited",
)

prefix_rule(
    pattern = ["git", "push", "-f"],
    decision = "forbidden",
    justification = "Force push is prohibited",
)

prefix_rule(
    pattern = ["gh", "repo", "delete"],
    decision = "forbidden",
    justification = "Repository deletion is prohibited",
)

prefix_rule(
    pattern = ["rm", "-rf", "/"],
    decision = "forbidden",
    justification = "Destructive filesystem wipe is prohibited",
)
